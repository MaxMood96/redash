#!/usr/bin/env python
import os
from distutils.dir_util import copy_tree

from pkg_resources import iter_entry_points, resource_filename, resource_isdir


PARENT_DIR = os.path.dirname(os.path.dirname(__file__))
EXTENSIONS_RELATIVE_PATH = os.path.join('client', 'app', 'extensions')
EXTENSIONS_DIRECTORY = os.path.join(PARENT_DIR, EXTENSIONS_RELATIVE_PATH)


# Make a directory for extensions to copy to
if not os.path.exists(EXTENSIONS_DIRECTORY):
    os.makedirs(EXTENSIONS_DIRECTORY)


for entry_point in iter_entry_points('redash.extensions'):
    # This is where the frontend code for an extension lives
    # inside of its package.

    split_module_path = entry_point.module_name.split(os.extsep)
    root_module = split_module_path.pop(0)

    content_folder_relative = os.path.join(os.path.join(
        *split_module_path), 'bundle')

    if not resource_isdir(root_module, content_folder_relative):
        continue

    content_folder = resource_filename(root_module, content_folder_relative)

    # This is where we place our extensions folder.
    destination = os.path.join(EXTENSIONS_DIRECTORY, entry_point.name)

    print(u"Copying %s to %s" % (content_folder, destination))
    copy_tree(content_folder, destination)
